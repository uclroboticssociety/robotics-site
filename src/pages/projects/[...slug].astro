---
import Base from "../../layouts/Base.astro";
import { getCollection } from "astro:content";
import type { ImageMetadata } from "astro";
import EventsLayout from "../../components/events/EventsLayout.astro";

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  const shortSlug = (entry) =>
    entry.slug.includes("/") ? entry.slug.split("/")[0] : entry.slug;
  return projects.map((project) => ({
    params: { slug: shortSlug(project) },
  }));
}

const slugParam = Astro.params.slug;
const slug = Array.isArray(slugParam) ? slugParam.join("/") : slugParam;

const projects = await getCollection("projects");
const shortSlug = (entry) =>
  entry.slug.includes("/") ? entry.slug.split("/")[0] : entry.slug;
const project = projects.find(
  (entry) => entry.slug === slug || shortSlug(entry) === slug
);

if (!project) {
  throw new Error(`Project not found: ${slug ?? "unknown"}`);
}

const sortByStatus: Record<string, number> = {
  active: 0,
  paused: 1,
  completed: 2,
};
const sorted = projects
  .slice()
  .sort((a, b) => sortByStatus[a.data.status] - sortByStatus[b.data.status]);

const projectSidebar = [
  {
    id: "vla",
    emoji: "ðŸ¤–",
    title: "VLA",
    href: "/projects",
    description: "Vision-Language-Action research and build track.",
    tag: "vla",
  },
];

const recentByInitiative = {
  vla: sorted.map((entry) => ({
    title: entry.data.title,
    href: `/projects/${shortSlug(entry)}`,
  })),
};

const body = project.body ?? "";
const pictureRegex = /\[picture\]\s*"([^"]+)"/g;
const blocks: Array<
  | { type: "text"; value: string }
  | { type: "image"; value: string }
> = [];

let lastIndex = 0;
for (const match of body.matchAll(pictureRegex)) {
  const textChunk = body.slice(lastIndex, match.index).trim();
  if (textChunk) blocks.push({ type: "text", value: textChunk });
  blocks.push({ type: "image", value: match[1] });
  lastIndex = (match.index ?? 0) + match[0].length;
}
const tail = body.slice(lastIndex).trim();
if (tail) blocks.push({ type: "text", value: tail });

const imageMap = import.meta.glob<ImageMetadata>(
  "/src/content/projects/**/*.{png,jpg,jpeg,webp,gif,svg}",
  { eager: true, import: "default" }
);
const baseDir = project.id.split("/").slice(0, -1).join("/");
const resolveImage = (file: string) => {
  const directKey = `/src/content/projects/${baseDir}/${file}`;
  const fallbackKey = `/src/content/projects/${file}`;
  const image = imageMap[directKey] ?? imageMap[fallbackKey];
  return image?.src ?? "";
};
const imageAlt = (file: string) =>
  file
    .replace(/\.[^/.]+$/, "")
    .replace(/[-_]+/g, " ")
    .trim();

const renderInline = (text: string) =>
  text.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");

const renderMarkdown = (text: string) => {
  const lines = text.split("\n");
  const html: string[] = [];
  const listStack: number[] = [];
  let paragraph: string[] = [];

  const closeParagraph = () => {
    if (!paragraph.length) return;
    html.push(
      `<p class="text-base md:text-lg leading-relaxed text-slate-700">${renderInline(
        paragraph.join(" ")
      )}</p>`
    );
    paragraph = [];
  };

  const closeLists = (targetLevel = 0) => {
    while (listStack.length > targetLevel) {
      html.push("</ul>");
      listStack.pop();
    }
  };

  const openList = () => {
    html.push('<ul class="list-disc pl-6 space-y-1 text-slate-700">');
    listStack.push(1);
  };

  lines.forEach((line) => {
    const trimmed = line.trim();
    if (!trimmed) {
      closeParagraph();
      return;
    }

    if (trimmed === "---") {
      closeParagraph();
      closeLists(0);
      html.push('<hr class="my-6 border-slate-200" />');
      return;
    }

    if (trimmed.startsWith("## ")) {
      closeParagraph();
      closeLists(0);
      html.push(
        `<h2 class="mt-6 text-xl md:text-2xl font-semibold text-slate-900">${renderInline(
          trimmed.slice(3)
        )}</h2>`
      );
      return;
    }

    if (trimmed.startsWith("### ")) {
      closeParagraph();
      closeLists(0);
      html.push(
        `<h3 class="mt-4 text-lg md:text-xl font-semibold text-slate-900">${renderInline(
          trimmed.slice(4)
        )}</h3>`
      );
      return;
    }

    const listMatch = line.match(/^(\s*)-\s+(.*)$/);
    if (listMatch) {
      const indent = listMatch[1].length;
      const level = Math.floor(indent / 2);
      closeParagraph();

      if (listStack.length < level + 1) {
        openList();
      } else if (listStack.length > level + 1) {
        closeLists(level + 1);
      }

      html.push(`<li>${renderInline(listMatch[2])}</li>`);
      return;
    }

    paragraph.push(trimmed);
  });

  closeParagraph();
  closeLists(0);
  return html.join("");
};
---

<Base title={`${project.data.title} â€” Robotics Society`}>
  <style>
    .fade-once {
      opacity: 0;
      transform: translateY(24px);
      transition: opacity 0.8s ease, transform 0.8s ease;
    }
    .fade-once.is-visible {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
  <EventsLayout
    title={project.data.title}
    initiatives={projectSidebar}
    currentId="vla"
    recentByInitiative={recentByInitiative}
    currentEventHref={`/projects/${shortSlug(project)}`}
    showHeader={false}
  >
    <section>
      <article class="mx-auto max-w-3xl fade-once">
        <header class="border-b border-slate-200 pb-6">
          <h1 class="text-3xl md:text-4xl font-semibold tracking-tight text-slate-900">
            {project.data.title}
          </h1>
          <div class="mt-4 flex flex-wrap items-center gap-3 text-sm text-slate-500">
            <span class="capitalize">{project.data.status}</span>
            {project.data.lead && <span>Lead: {project.data.lead}</span>}
          </div>
          {project.data.summary && (
            <p class="mt-3 text-slate-600">{project.data.summary}</p>
          )}
        </header>
        <div class="mt-8 space-y-6">
          {blocks.map((block) => {
            if (block.type === "image") {
              const src = resolveImage(block.value);
              return src ? (
                <img
                  src={src}
                  alt={imageAlt(block.value)}
                  class="w-full rounded-2xl border border-slate-200 bg-white/80 shadow-sm"
                  loading="lazy"
                />
              ) : (
                <div class="rounded-2xl border border-dashed border-slate-300 bg-white/60 px-4 py-6 text-sm text-slate-500">
                  Image not found: {block.value}
                </div>
              );
            }
            return <div set:html={renderMarkdown(block.value)} />;
          })}
        </div>
      </article>
    </section>
  </EventsLayout>
</Base>

<script>
  const content = document.querySelector('.fade-once');
  if (content) {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (!entry.isIntersecting) return;
        entry.target.classList.add('is-visible');
        observer.unobserve(entry.target);
      });
    }, { threshold: 0.2 });

    observer.observe(content);
  }
</script>
