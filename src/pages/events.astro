---
import Base from "../layouts/Base.astro";
import { getCollection } from "astro:content";
import EventsLayout from "../components/events/EventsLayout.astro";
import { initiatives } from "../data/events";

const allEvents = await getCollection("events");
const sortByDate = (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
const shortSlug = (entry) => (entry.slug.includes("/") ? entry.slug.split("/")[0] : entry.slug);
const workshops = allEvents.filter((e) => e.data.tags?.includes("workshop")).sort(sortByDate);
const hackathons = allEvents.filter((e) => e.data.tags?.includes("hackathon")).sort(sortByDate);
const challenges = allEvents.filter((e) => e.data.tags?.includes("challenge")).sort(sortByDate);
const socials = allEvents.filter((e) => e.data.tags?.includes("social")).sort(sortByDate);

const folderLabel = (event) => event.id.split("/").slice(-2, -1)[0] ?? event.data.title;
const recentByInitiative = {
  workshops: workshops.map((event) => ({
    title: folderLabel(event),
    href: `/events/${shortSlug(event)}`,
  })),
  hackathons: hackathons.map((event) => ({
    title: folderLabel(event),
    href: `/events/${shortSlug(event)}`,
  })),
  challenges: challenges.map((event) => ({
    title: folderLabel(event),
    href: `/events/${shortSlug(event)}`,
  })),
  socials: socials.map((event) => ({
    title: folderLabel(event),
    href: `/events/${shortSlug(event)}`,
  })),
};
const latest = [...allEvents].sort(sortByDate)[0];

const tagLabels: Record<string, string> = {
  workshop: "Workshop",
  hackathon: "Hackathon",
  challenge: "Challenge",
  social: "Social",
};

const latestContent = latest ? (await latest.render()).Content : null;
const latestEvent = latest ? { ...latest, Content: latestContent } : null;
const latestTag = latestEvent?.data.tags
  ?.map((tag) => tagLabels[tag])
  .find(Boolean);
const LatestContent = latestEvent?.Content ?? null;

const formatDate = (iso: string) => {
  const date = new Date(iso);
  return date.toLocaleDateString("en-US", {
    weekday: "short",
    year: "numeric",
    month: "short",
    day: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
};
---

<Base title="Events â€” UCL Robotics Society">
  <EventsLayout
    title="Events"
    intro="Latest updates from our workshops, hackathons, challenges, and socials."
    initiatives={initiatives}
    recentByInitiative={recentByInitiative}
  >
    <section>
      <h2 class="text-2xl md:text-3xl font-semibold tracking-tight text-slate-900">Latest Event</h2>
      {latestEvent ? (
        <article class="mt-6 rounded-2xl border border-slate-200 bg-white/70 p-6 shadow-sm">
          <div class="flex flex-wrap items-center gap-3 text-sm text-slate-500">
            <span>{formatDate(latestEvent.data.date)}</span>
            {latestTag && (
              <span class="rounded-full border border-slate-200 bg-white px-3 py-1 text-xs uppercase tracking-wide text-slate-600">
                {latestTag}
              </span>
            )}
          </div>
          <h3 class="mt-3 text-xl font-semibold text-slate-900">{latestEvent.data.title}</h3>
          {latestEvent.data.location && (
            <p class="mt-2 flex items-center gap-1 text-slate-600">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              {latestEvent.data.location}
            </p>
          )}
          {LatestContent && (
            <div class="mt-4 text-slate-700 leading-relaxed">
              <LatestContent />
            </div>
          )}
          {latestEvent.data.signup_url && (
            <a
              class="mt-5 inline-flex rounded-lg px-4 py-2 text-sm bg-indigo-600 text-white hover:bg-indigo-700 transition"
              href={latestEvent.data.signup_url}
              target="_blank"
              rel="noopener noreferrer"
            >
              RSVP
            </a>
          )}
        </article>
      ) : (
        <p class="mt-6 text-slate-600">No events announced yet.</p>
      )}
    </section>
  </EventsLayout>
</Base>
