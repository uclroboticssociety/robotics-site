---
import Base from "../layouts/Base.astro";
import { getCollection, type CollectionEntry } from "astro:content";

// 集合条目的类型
type ProjectEntry = CollectionEntry<"projects">;
// 从集合类型里取出 status 的联合类型
type ProjectStatus = ProjectEntry["data"]["status"];

// 为状态排序表提供精确的键类型
const statusOrder: Record<ProjectStatus, number> = {
  active: 0,
  paused: 1,
  completed: 2,
};

// 读取项目
const projects: ProjectEntry[] = await getCollection("projects");

// 渲染每个项目的 Markdown 内容
const projectsWithContent = await Promise.all(
  projects.map(async (entry) => {
    try {
      const rendered = await entry.render();
      return { ...entry, Content: rendered.Content };
    } catch (error) {
      // 如果渲染失败，返回没有 Content 的条目
      return { ...entry, Content: null };
    }
  })
);

// 排序
const sorted = projectsWithContent
  .slice()
  .sort(
    (a, b) =>
      statusOrder[a.data.status] - statusOrder[b.data.status]
  );
---

<Base title="Projects — Robotics Society">
  <section class="mx-auto max-w-6xl px-4 py-12">
    <h2 class="text-2xl font-semibold">Our Projects</h2>
    <p class="text-slate-600 mt-2 mb-6">
      Explore our robotics initiatives — from beginner builds to advanced research collaborations.
    </p>

    {sorted.length > 0 ? (
      <div class="grid md:grid-cols-3 gap-6">
        {sorted.map((entry) => {
          const { data, slug, Content } = entry;
          return (
            <article class="rounded-2xl shadow-lg p-6 bg-white/70 border border-slate-200 hover:shadow-xl transition">
              <div class="aspect-video rounded-xl bg-slate-100 flex items-center justify-center">
                <span class="text-slate-400 text-sm">[ project image ]</span>
              </div>
              <h3 class="font-semibold mt-3 text-xl">{data.title}</h3>
              <p class="text-slate-600 mt-1 text-sm font-medium">{data.summary}</p>

              {/* 展示 Markdown 正文内容 */}
              {Content && (
                <div class="mt-3 text-slate-700 text-sm leading-relaxed">
                  <Content />
                </div>
              )}

              <div class="mt-3 text-sm text-slate-500 flex flex-col gap-1">
                <div>Status: <span class="font-medium capitalize">{data.status}</span></div>
                {data.lead && <div>Lead: <span class="font-medium">{data.lead}</span></div>}
              </div>

              <div class="mt-4 flex gap-3 flex-wrap">
                {data.repo && (
                  <a href={data.repo} class="rounded-lg px-3 py-2 text-sm bg-indigo-600 text-white hover:bg-indigo-700" target="_blank" rel="noopener noreferrer">
                    View Repo
                  </a>
                )}
                <a href="/join" class="rounded-lg px-3 py-2 text-sm border border-slate-300 hover:border-slate-400">
                  Join
                </a>
              </div>
            </article>
          );
        })}
      </div>
    ) : (
      <div class="text-center py-12">
        <p class="text-slate-600">暂无项目展示</p>
        <p class="text-slate-500 text-sm mt-2">项目内容将在稍后添加</p>
      </div>
    )}
  </section>
</Base>
