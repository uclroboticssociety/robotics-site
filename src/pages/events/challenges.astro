---
import Base from "../../layouts/Base.astro";
import { getCollection, type CollectionEntry } from "astro:content";

type EventEntry = CollectionEntry<"events">;

const allEvents = await getCollection("events");

// 渲染每个活动的 Markdown 内容
const eventsWithContent = await Promise.all(
  allEvents.map(async (entry) => {
    try {
      const rendered = await entry.render();
      return { ...entry, Content: rendered.Content };
    } catch (error) {
      return { ...entry, Content: null };
    }
  })
);

// 筛选 challenges
const challenges = eventsWithContent
  .filter((e) => e.data.tags?.includes("challenge"))
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

// 格式化日期
const formatDate = (iso: string) => {
  const date = new Date(iso);
  return date.toLocaleDateString("en-US", {
    weekday: "short",
    year: "numeric",
    month: "short",
    day: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
};
---

<Base title="Challenges — Robotics Society">
  <section class="mx-auto max-w-6xl px-4 py-12">
    <div class="mb-6">
      <a href="/events" class="text-indigo-600 hover:text-indigo-700 text-sm">← Back to Events</a>
    </div>
    <h1 class="text-3xl font-semibold tracking-tight">Challenges</h1>
    <p class="text-slate-600 mt-2">Competitive events to test your skills and creativity.</p>

    {challenges.length > 0 ? (
      <div class="grid md:grid-cols-2 gap-6 mt-8">
        {challenges.map((entry) => {
          const { data, slug, Content } = entry;
          return (
            <article class="rounded-2xl shadow p-6 bg-white/70 border border-slate-200 hover:shadow-xl transition">
              <div class="flex items-start justify-between mb-3">
                <div class="text-sm text-slate-500">{formatDate(data.date)}</div>
                <span class="px-2 py-1 rounded text-xs bg-orange-100 text-orange-700">Challenge</span>
              </div>
              <h3 class="font-semibold text-xl mt-2">{data.title}</h3>
              {data.location && (
                <p class="text-slate-600 mt-2 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                  </svg>
                  {data.location}
                </p>
              )}
              {Content && (
                <div class="mt-3 text-slate-700 text-sm leading-relaxed">
                  <Content />
                </div>
              )}
              {data.signup_url && (
                <a
                  class="mt-4 inline-block rounded-lg px-4 py-2 text-sm bg-indigo-600 text-white hover:bg-indigo-700 transition"
                  href={data.signup_url}
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  RSVP
                </a>
              )}
            </article>
          );
        })}
      </div>
    ) : (
      <div class="text-center py-12 mt-8">
        <p class="text-slate-600">No challenges scheduled at the moment.</p>
        <p class="text-slate-500 text-sm mt-2">Check back soon for upcoming challenges!</p>
      </div>
    )}
  </section>
</Base>
