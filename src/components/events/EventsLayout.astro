---
import type { EventInitiative } from "../../data/events";

type Props = {
  title: string;
  intro?: string;
  initiatives: EventInitiative[];
  currentId?: EventInitiative["id"];
  recentByInitiative?: Partial<Record<EventInitiative["id"], { title: string; href: string }[]>>;
  currentEventHref?: string;
  showHeader?: boolean;
};

const {
  title,
  intro,
  initiatives,
  currentId,
  recentByInitiative = {},
  currentEventHref,
  showHeader = true,
} = Astro.props;
---

<article class="mx-auto max-w-6xl px-1 md:px-3 py-12 md:py-16" data-events-accordion>
  <div class="md:grid md:grid-cols-[240px_1fr] md:gap-12 lg:gap-16">
    <aside class="md:sticky md:top-24 md:self-start">
      <h2 class="text-xs font-semibold uppercase tracking-wider text-slate-500 mb-4">Explore events</h2>
      <div class="space-y-3">
        {initiatives.map((initiative) => (
          <details
            class={`group rounded-2xl border p-3 shadow-sm transition hover:border-slate-300 ${
              initiative.id === currentId
                ? "border-indigo-300 bg-indigo-50/70"
                : "border-slate-200 bg-white/70"
            }`}
            open={initiative.id === currentId}
          >
            <summary
              class={`flex cursor-pointer list-none items-center justify-between gap-3 text-sm font-semibold ${
                initiative.id === currentId ? "text-indigo-900" : "text-slate-800"
              }`}
            >
              <span class="flex items-center gap-2">
                <span class="text-base" aria-hidden="true">{initiative.emoji}</span>
                {initiative.title}
              </span>
              <svg class="h-4 w-4 text-slate-500 transition duration-200 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
              </svg>
            </summary>
            <div class="mt-3 text-sm text-slate-600 leading-relaxed">
              {recentByInitiative[initiative.id]?.length ? (
                <ul class="space-y-2 text-sm">
                  {recentByInitiative[initiative.id]?.map((event) => (
                    <li>
                      <a
                        href={event.href}
                        class={`inline-flex items-center gap-2 rounded-md px-2 py-1 transition ${
                          event.href === currentEventHref
                            ? "text-indigo-700 font-semibold bg-indigo-100/70"
                            : "text-slate-700 hover:text-indigo-600"
                        }`}
                      >
                        <span
                          class={`h-1.5 w-1.5 rounded-full ${
                            event.href === currentEventHref ? "bg-indigo-600" : "bg-indigo-400"
                          }`}
                          aria-hidden="true"
                        ></span>
                        {event.title}
                      </a>
                    </li>
                  ))}
                </ul>
              ) : null}
            </div>
          </details>
        ))}
      </div>
    </aside>

    <div class="mt-6 md:mt-0">
      {showHeader && (
        <header class="mt-10 md:mt-0 mb-10 md:mb-12">
          <h1 class="text-3xl md:text-4xl font-semibold tracking-tight text-slate-900">{title}</h1>
          {intro && (
            <p class="mt-3 text-slate-600 max-w-2xl leading-relaxed">{intro}</p>
          )}
        </header>
      )}
      <slot />
    </div>
  </div>
</article>

<script>
  const root = document.querySelector("[data-events-accordion]");
  if (root) {
    const items = Array.from(root.querySelectorAll("details"));
    items.forEach((item) => {
      item.addEventListener("toggle", () => {
        if (!item.open) return;
        items.forEach((other) => {
          if (other !== item) other.open = false;
        });
      });
    });
  }
</script>
